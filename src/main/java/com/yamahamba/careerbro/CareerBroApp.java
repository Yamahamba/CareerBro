package com.yamahamba.careerbro;

import io.github.cdimascio.dotenv.Dotenv;
import org.telegram.telegrambots.meta.TelegramBotsApi;
import org.telegram.telegrambots.meta.api.objects.Message;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;
import org.telegram.telegrambots.updatesreceivers.DefaultBotSession;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.logging.Logger;

/**
 * –ö–∞—Ä—å–µ—Ä–Ω—ã–π –±–æ—Ç:
 * - /cv        ‚Äî –º–∞—Å—Ç–µ—Ä —Ä–µ–∑—é–º–µ (8 —à–∞–≥–æ–≤-–≤–æ—Ä–∫—à–æ–ø)
 * - /cover     ‚Äî —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ (2 —à–∞–≥–∞: –†–µ–∑—é–º–µ -> /done -> –í–∞–∫–∞–Ω—Å–∏—è -> /done)
 * - /interview ‚Äî –ø—Ä–∞–∫—Ç–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é
 * - /support   ‚Äî –ø—Å–∏—Ö–æ-–ø–æ–¥–¥–µ—Ä–∂–∫–∞
 * - /navigator ‚Äî –∫–∞—Ä—å–µ—Ä–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä (–≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã, –∫–∞—Ä—å–µ—Ä—É –∏ —Ä—ã–Ω–æ–∫)
 * - /direction ‚Äî –ø–æ–º–æ—â—å –ø–æ–Ω—è—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
 */
public class CareerBroApp extends MultiSessionTelegramBot {

    private static final Dotenv dotenv = Dotenv.load();
    private static final String TELEGRAM_BOT_NAME  = dotenv.get("TELEGRAM_BOT_NAME");
    private static final String TELEGRAM_BOT_TOKEN = dotenv.get("TELEGRAM_BOT_TOKEN");
    private static final String OPEN_AI_TOKEN      = dotenv.get("OPENAI_API_KEY");
    private static final Logger log = Logger.getLogger(CareerBroApp.class.getName());

    private final ChatGPTService chatGPT = new ChatGPTService(OPEN_AI_TOKEN);
    private DialogMode currentMode = null;

    // ===== –ü–∞–º—è—Ç—å –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: userId -> UserMemory =====

    private final Map<Long, UserMemory> memoryByUser = new ConcurrentHashMap<>();

    private UserMemory getMemory() {
        Long chatId = getCurrentChatId();
        if (chatId == null) {
            // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ–π–º–∞—Ç—å NPE
            return new UserMemory();
        }
        return memoryByUser.computeIfAbsent(chatId, id -> new UserMemory());
    }

    // ===== CV: –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –≤–æ—Ä–∫—à–æ–ø =====

    private enum CvStage {
        NONE,
        STEP1_WHO,             // –∫—Ç–æ —Ç—ã –∏ –Ω–∞ –∫–∞–∫—É—é —Ä–æ–ª—å —Ü–µ–ª–∏—à—å—Å—è
        STEP2_EXPERIENCE,      // –æ–±—â–∏–π –æ–±–∑–æ—Ä –æ–ø—ã—Ç–∞ + –∫–æ–º–ø–∞–Ω–∏–∏/—Ä–æ–ª–∏/–¥–∞—Ç—ã
        STEP3_RESPONSIBILITIES,// —á–µ–º –∑–∞–Ω–∏–º–∞–ª—Å—è –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 1‚Äì2 —Ä–æ–ª—è—Ö
        STEP4_IMPACT,          // –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —Ü–∏—Ñ—Ä–∞–º–∏
        STEP5_SKILLS,          // –Ω–∞–≤—ã–∫–∏, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø–æ–¥—Ö–æ–¥—ã
        STEP6_PROJECTS,        // –ø—Ä–æ–µ–∫—Ç—ã / —á–µ–º –≥–æ—Ä–¥–∏—à—å—Å—è
        STEP7_EDUCATION,       // –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∫—É—Ä—Å—ã
        STEP8_EXTRA            // –ª–∏—á–Ω–æ–µ, —á—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç
    }

    private CvStage cvStage = CvStage.NONE;

    private static class CvData {
        String who;             // –∫—Ç–æ —Ç—ã –∏ —Ü–µ–ª—å
        String experience;      // –∫–æ–º–ø–∞–Ω–∏–∏, —Ä–æ–ª–∏, —Å—Ä–æ–∫–∏
        String responsibilities;// —á–µ–º –∑–∞–Ω–∏–º–∞–ª—Å—è
        String impact;          // –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è/—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        String skills;          // –Ω–∞–≤—ã–∫–∏/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        String projects;        // –ø—Ä–æ–µ–∫—Ç—ã / —á–µ–º –≥–æ—Ä–¥–∏—Ç—Å—è
        String education;       // –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ/–∫—É—Ä—Å—ã
        String extra;           // –ª–∏—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã, —Å—Ç–∏–ª—å, —Ü–µ–Ω–Ω–æ—Å—Ç–∏
    }

    private CvData cvData = new CvData();

    // ===== COVER: –¥–≤—É—Ö—à–∞–≥–æ–≤—ã–π –≤–∏–∑–∞—Ä–¥ —Å –∞–∫–∫—É–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞ =====

    private enum CoverStage { NONE, RESUME, VACANCY }
    private CoverStage coverStage = CoverStage.NONE;
    private final StringBuilder resumeBuf  = new StringBuilder();
    private final StringBuilder vacancyBuf = new StringBuilder();

    // –ü–æ—Ä–æ–≥ –∞–≤—Ç–æ-—Å–∂–∞—Ç–∏—è –≤—Ö–æ–¥–∞ (—Å–∏–º–≤–æ–ª—ã). –ï—Å–ª–∏ —Å—É–º–º–∞—Ä–Ω–æ > THRESHOLD ‚Äî —Å–Ω–∞—á–∞–ª–∞ ¬´—É–∂–º—ë–º¬ª, –ø–æ—Ç–æ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º.
    private static final int COMPRESS_THRESHOLD = 8000;

    public CareerBroApp() {
        super(TELEGRAM_BOT_NAME, TELEGRAM_BOT_TOKEN);
    }

    @Override
    public void onUpdateEventReceived(Update update) {
        Message msg = update.getMessage();
        if (msg != null && !msg.hasText()) {
            Long chatId = msg.getChatId();
            sendTextMessage("–Ø –ø–æ–∫–∞ –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–æ–≤–∞–º–∏ üôÇ");
            log.info("Ignored non-text message from chat " + chatId);
            return;
        }
        String text = getMessageText();

        // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ñ–æ—Ç–æ, –≥–æ–ª–æ—Å, —Å—Ç–∏–∫–µ—Ä –∏ —Ç.–ø.)
        if (text == null || text.isBlank()) {
            if (update.getMessage() != null && !update.getMessage().hasText()) {
                sendTextMessage("–Ø –ø–æ–∫–∞ –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–æ–≤–∞–º–∏ üôÇ");
                return;
            }
            // –µ—Å–ª–∏ –ø–æ—á–µ–º—É-—Ç–æ —Ç–µ–∫—Å—Ç –≤—Å—ë-—Ç–∞–∫–∏ null, –Ω–æ —ç—Ç–æ –Ω–µ —Ñ–æ—Ç–æ/–≥–æ–ª–æ—Å ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—á–∏—Ç–∞–µ–º –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
            text = "";
        }

        // ===== /start =====
        if (text.equals("/start")) {
            resetCv();
            resetCover();
            currentMode = DialogMode.MAIN;

            // –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≥–ª–∞–≤–Ω–æ–π
            sendPhotoMessage("main");

            // –Ω–æ–≤—ã–π –∂–∏–≤–æ–π —Ç–µ–∫—Å—Ç
            String mainGreeting = """
                    –ü—Ä–∏–≤–µ—Ç, —Ç–∞–ª–∞–Ω—Ç –≤ –ø–æ–∏—Å–∫–µ üòä

                    –ó–¥–µ—Å—å –Ω–µ –±—É–¥—É—Ç —É—á–∏—Ç—å ¬´–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∂–∏—Ç—å¬ª.
                    –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –∫—É–¥–∞ —Ç–µ–±—è —Ä–µ–∞–ª—å–Ω–æ —Ç—è–Ω–µ—Ç –∏ —á—Ç–æ —Å —ç—Ç–∏–º –≤–æ–æ–±—â–µ –¥–µ–ª–∞—Ç—å.

                    –ù–∞–ø–∏—à–∏ –ø–∞—Ä—É —Å—Ç—Ä–æ–∫: —É —Ç–µ–±—è —Å–µ–π—á–∞—Å —Ç—É–ø–∏–∫, —Ä–∞–∑–≤–∏–ª–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ?
                    """;
            sendLongMessage(mainGreeting);

            // system-prompt –¥–ª—è MAIN-–¥–∏–∞–ª–æ–≥–∞
            String mainPrompt = safeLoadPrompt("modes/main",
                    "–¢—ã ‚Äî Yamahamba, –∂–∏–≤–∞—è, —Ç—ë–ø–ª–∞—è –∏ –Ω–µ–º–Ω–æ–≥–æ –¥–µ—Ä–∑–∫–∞—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Å–µ—Å—Ç—Ä—ë–Ω–∫–∞.\n" +
                            "\n" +
                            "–ö —Ç–µ–±–µ –∑–∞—Ö–æ–¥–∏—Ç —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ —É–≤–∏–¥–µ–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.\n" +
                            "–¢—ã –ù–ï –ø–æ–≤—Ç–æ—Ä—è–µ—à—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å —Ä–∞–∑–≥–æ–≤–æ—Ä, –∫–∞–∫ –±—É–¥—Ç–æ –æ–Ω –Ω–∞–ø–∏—Å–∞–ª —Ç–µ–±–µ –≤ –ª–∏—á–∫—É.\n" +
                            "\n" +
                            "–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:\n" +
                            "- –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –Ω–∞ ¬´—Ç—ã¬ª;\n" +
                            "- –≥–æ–≤–æ—Ä–∏—à—å –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞ –∏ –ø–∞—Ñ–æ—Å–∞;\n" +
                            "- 3‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ –æ—Ç–≤–µ—Ç–µ, –Ω–µ –ø—Ä–æ—Å—Ç—ã–Ω—è;\n" +
                            "- –º–æ–∂–Ω–æ –ª—ë–≥–∫–∏–π —é–º–æ—Ä –∏ —Å–∞–º–æ–∏—Ä–æ–Ω–∏—é, –Ω–æ –±–µ–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ –∏ –¥–∞–≤–ª–µ–Ω–∏—è;\n" +
                            "- —Ç—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —á–µ–ª–æ–≤–µ–∫–∞, –Ω–µ —á–∏—Ç–∞–µ—à—å –ª–µ–∫—Ü–∏–∏ –∏ –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–µ—à—å.\n" +
                            "\n" +
                            "–¢–≤–æ–∏ –∑–∞–¥–∞—á–∏ –≤ MAIN:\n" +
                            "1) –ü–æ–Ω—è—Ç—å, —á—Ç–æ —É –Ω–µ–≥–æ —Å–µ–π—á–∞—Å –≤–Ω—É—Ç—Ä–∏: —Ç—É–ø–∏–∫, –≤—ã–≥–æ—Ä–∞–Ω–∏–µ, —Ä–∞–∑–≤–∏–ª–∫–∞, –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ, –∂–µ–ª–∞–Ω–∏–µ —Ä–æ—Å—Ç–∞, —Å—Ç—Ä–∞—Ö, —É—Å—Ç–∞–ª–æ—Å—Ç—å.\n" +
                            "2) –ó–∞–¥–∞—Ç—å 1‚Äì2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –µ–≥–æ —Å–∏—Ç—É–∞—Ü–∏—é.\n" +
                            "3) –î–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –ø–æ–ª—å–∑—É –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å: 1‚Äì3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º—ã—Å–ª–∏ –∏–ª–∏ —à–∞–≥–∞, –±–µ–∑ \"–≤–æ–ª—à–µ–±–Ω—ã—Ö —Ç–∞–±–ª–µ—Ç–æ–∫\".\n" +
                            "4) –ö–æ–≥–¥–∞ –ø–æ —Å–º—ã—Å–ª—É –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ –µ–º—É –ø–æ–º–æ–∂–µ—Ç, –º—è–≥–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–¥–∏–Ω –∏–∑ —Ä–µ–∂–∏–º–æ–≤, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞—Ç—å:\n" +
                            "\n" +
                            "- /direction ‚Äî –µ—Å–ª–∏ —Ä–µ—á—å –ø—Ä–æ ¬´—è –Ω–µ –ø–æ–Ω–∏–º–∞—é, –∫–µ–º –±—ã—Ç—å, –∫—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è¬ª.\n" +
                            "- /navigator ‚Äî –µ—Å–ª–∏ –æ–Ω —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –≤–∞–∫–∞–Ω—Å–∏–∏, –∑–∞—Ä–ø–ª–∞—Ç—ã.\n" +
                            "- /cv ‚Äî –µ—Å–ª–∏ –æ–Ω —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ —Ä–µ–∑—é–º–µ, –æ–ø—ã—Ç, ¬´–∫–∞–∫ —Å–µ–±—è —É–ø–∞–∫–æ–≤–∞—Ç—å¬ª.\n" +
                            "- /cover ‚Äî –µ—Å–ª–∏ –æ–Ω –ø—Ä–æ –æ—Ç–∫–ª–∏–∫–∏ –∏ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∏—Å—å–º–∞.\n" +
                            "- /support ‚Äî –µ—Å–ª–∏ –µ–º—É –ø–ª–æ—Ö–æ, —Ç—Ä–µ–≤–æ–∂–Ω–æ, –æ–Ω –≤—ã–≥–æ—Ä–µ–ª –∏–ª–∏ –∑–∞—Å—Ç—Ä—è–ª —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ.\n" +
                            "- /interview ‚Äî –µ—Å–ª–∏ –æ–Ω –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é –∏ —Ö–æ—á–µ—Ç –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n" +
                            "\n" +
                            "–ö–∞–∫ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Ä–µ–∂–∏–º—ã:\n" +
                            "- –°–Ω–∞—á–∞–ª–∞ –≤—ã—Å–ª—É—à–∞–π, —É—Ç–æ—á–Ω–∏, –¥–∞–π –º–∞–ª–µ–Ω—å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ –º—ã—Å–ª—å.\n" +
                            "- –ü–æ—Ç–æ–º –º–æ–∂–µ—à—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: \"–°–ª—É—à–∞–π, —Ç—É—Ç —É–∂–µ —Ç—è–Ω–µ—Ç –Ω–∞ —Ü–µ–ª—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–∞–≤–∞–π –∑–∞–π–¥—ë–º –≤ /navigator –∏ —Ä–∞–∑–ª–æ–∂–∏–º –ø–æ —à–∞–≥–∞–º\".\n" +
                            "- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–µ —Ö–æ—á–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π –¥–∏–∞–ª–æ–≥ –≤ MAIN.\n" +
                            "\n" +
                            "–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç –Ω–µ —Å—Ç—Ä–æ–≥–æ –ø—Ä–æ —Ä–∞–±–æ—Ç—É (–ø—Ä–æ –∂–∏–∑–Ω—å, —Å—Ç—Ä–∞—Ö–∏, —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É) ‚Äî —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–≤–µ—á–∞–µ—à—å –±–µ—Ä–µ–∂–Ω–æ\n" +
                            "–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å /support, –Ω–æ –±–µ–∑ –Ω–∞–≤—è–∑—á–∏–≤–æ—Å—Ç–∏.\n" +
                            "\n" +
                            "–í –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ –ø–æ–º–Ω–∏: —Ç–≤–æ—è —Ä–æ–ª—å ‚Äî —É–º–Ω–∞—è, —Ç—ë–ø–ª–∞—è, –∏—Ä–æ–Ω–∏—á–Ω–∞—è –ø–æ–¥—Ä—É–≥–∞, –∞ –Ω–µ —Å—Ç—Ä–æ–≥–∏–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç."
            );
            chatGPT.setPrompt(withUserMemory(mainPrompt));

            // –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å
            showMainMenu("–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞", "/start",
                    "–ø–æ–Ω—è—Ç—å, –∫—É–¥–∞ –∏–¥—Ç–∏ üß©", "/direction",
                    "—Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑—é–º–µ üìÑ", "/cv",
                    "—Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ ‚úâÔ∏è", "/cover",
                    "–ø—Ä–∞–∫—Ç–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é üé§", "/interview",
                    "–ø—Å–∏—Ö–æ-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚ù§Ô∏è", "/support",
                    "–∫–∞—Ä—å–µ—Ä–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä üß≠", "/navigator");
            return;
        }

        // ===== DIRECTION =====
        if (text.equals("/direction")) {
            currentMode = DialogMode.DIRECTION;
            sendPhotoMessage("direction");
            sendLongMessage(safeLoadMessage("direction",
                    "–ò–Ω–æ–≥–¥–∞ —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ ‚Äî –Ω–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—é–º–µ, –∞ –ø–æ–Ω—è—Ç—å, **–≤ –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É –≤–æ–æ–±—â–µ –¥–≤–∏–≥–∞—Ç—å—Å—è**.\n\n" +
                            "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤–º–µ—Å—Ç–µ ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.\n\n" +
                            "–Ø –ø—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã —Ç—ã —Å–∞–º(–∞) —É–≤–∏–¥–µ–ª(–∞), —á—Ç–æ —Ç–µ–±–µ –±–ª–∏–∂–µ, —á—Ç–æ –¥–∞—ë—Ç —ç–Ω–µ—Ä–≥–∏—é, –∞ —á—Ç–æ –≤—ã–º–∞—Ç—ã–≤–∞–µ—Ç.\n\n" +
                            "üí¨ –ü—Ä–∏–º–µ—Ä–Ω–æ –æ —á—ë–º –º–æ–∂–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å:\n" +
                            "‚Ä¢ –ß—Ç–æ —Ç–µ–±–µ —Ä–µ–∞–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –¥–∞—ë—Ç –æ—â—É—â–µ–Ω–∏–µ ¬´–∂–∏–≤–æ—Å—Ç–∏¬ª?\n" +
                            "‚Ä¢ –í –∫–∞–∫–∏—Ö –∑–∞–¥–∞—á–∞—Ö —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å?\n" +
                            "‚Ä¢ –ö–∞–∫–æ–π —Å—Ç–∏–ª—å –∂–∏–∑–Ω–∏ —Ç–µ–±–µ –±–ª–∏–∂–µ ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —Å–≤–æ–±–æ–¥–∞, —Ä–æ—Å—Ç, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ?\n" +
                            "‚Ä¢ –ß—Ç–æ –±—ã —Ç—ã –¥–µ–ª–∞–ª(–∞), –µ—Å–ª–∏ –±—ã –Ω–µ –¥—É–º–∞–ª(–∞) –æ –¥–µ–Ω—å–≥–∞—Ö?\n\n" +
                            "–ü–∏—à–∏, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –≥–æ–ª–æ–≤—É ‚Äî —è –ø–æ–º–æ–≥—É –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–ª–æ–∂–∏—Ç—å –∏–∑ —ç—Ç–æ–≥–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.\n\n" +
                            "–ö–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –º–æ–∂–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –≤ /navigator, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, **–∫–∞–∫ —Ç—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è** –ø–æ —à–∞–≥–∞–º."
            ));

            String prompt = safeLoadPrompt("modes/direction",
                    "–¢—ã ‚Äî CareerBro Direction, –º—è–≥–∫–∏–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫. –ü–æ–º–æ–≥–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫—É –ø–æ–Ω—è—Ç—å, –∫—É–¥–∞ –µ–º—É –¥–≤–∏–≥–∞—Ç—å—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.\n" +
                            "–ù–µ –¥–∞—ë—à—å –≥–æ—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –∞ –∑–∞–¥–∞—ë—à—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–º–æ–≥–∞–µ—à—å –≤–∏–¥–µ—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏, –Ω–∞–≤—ã–∫–∞–º–∏ –∏ –∂–µ–ª–∞–Ω–∏—è–º–∏.\n" +
                            "–¢–æ–Ω —Å–ø–æ–∫–æ–π–Ω—ã–π, –∫–∞–∫ —É –¥—Ä—É–≥–∞. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.\n" +
                            "–ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–æ—è—Å–Ω—è–µ—Ç –º—ã—Å–ª—å, –ø–æ–¥–¥–µ—Ä–∂–∏ –µ–≥–æ –∏ –ø–æ–º–æ–≥–∏ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥.");
            chatGPT.setPrompt(withUserMemory(prompt));
            return;
        }

        if (currentMode == DialogMode.DIRECTION && !isMessageCommand()) {
            // –∑–∞–ø–∏—à–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
            UserMemory mem = getMemory();
            mem.lastDirectionNote = text;

            Message wait = sendTextMessage("‚Ä¶");
            updateTextMessage(wait, chatGPT.addMessage(text));
            return;
        }

        // ===== NAVIGATOR =====
        if (text.equals("/navigator")) {
            currentMode = DialogMode.NAVIGATOR;
            sendPhotoMessage("navigator");
            sendLongMessage(safeLoadMessage("navigator",
                    "–≠—Ç–æ –∫–∞—Ä—å–µ—Ä–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä üß≠\n\n" +
                            "–ú–æ–∂–µ—à—å —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã, —Ä—ã–Ω–æ–∫, –∑–∞—Ä–ø–ª–∞—Ç—ã, —Å–º–µ–Ω—É —Å—Ñ–µ—Ä—ã, " +
                            "–∫–∞–∫ —É–ø–∞–∫–æ–≤–∞—Ç—å –æ–ø—ã—Ç –∏–ª–∏ —Å —á–µ–≥–æ –≤–æ–æ–±—â–µ –Ω–∞—á–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ. " +
                            "–û—Ç–≤–µ—á—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ-–¥–µ–ª—É –∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º."));

            String prompt = safeLoadPrompt("modes/navigator",
                    "–¢—ã ‚Äî –∫–∞—Ä—å–µ—Ä–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä. –ü–æ–º–æ–≥–∞–µ—à—å —á–µ–ª–æ–≤–µ–∫—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ø–æ–∏—Å–∫–æ–º —Ä–∞–±–æ—Ç—ã, " +
                            "–∫–∞—Ä—å–µ—Ä–æ–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ä–∞–∑–≤–∏—Ç–∏–µ–º.\n\n" +
                            "–û—Ç–≤–µ—á–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ –∏ –ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É: –±–µ–∑ –ø–∞—Ñ–æ—Å–∞, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ. " +
                            "–§–æ–∫—É—Å ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏, –∞ –Ω–µ –æ–±—â–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è.\n\n" +
                            "–ß—Ç–æ –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å:\n" +
                            "‚Ä¢ –∫–∞–∫ –∏—Å–∫–∞—Ç—å —Ä–∞–±–æ—Ç—É (–∫–∞–Ω–∞–ª—ã, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, —Ñ–æ–∫—É—Å);\n" +
                            "‚Ä¢ –∫–∞–∫ –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏ —É—Ä–æ–≤–µ–Ω—å —Ü–µ–ª–∏—Ç—å—Å—è;\n" +
                            "‚Ä¢ –∫–∞–∫ –æ—Ü–µ–Ω–∏—Ç—å —Å–≤–æ—é –∑–∞—Ä–ø–ª–∞—Ç—É –∏ –≤–∏–ª–∫—É –æ—Ñ—Ñ–µ—Ä–æ–≤;\n" +
                            "‚Ä¢ –∫–∞–∫ —É–ø–∞–∫–æ–≤–∞—Ç—å –æ–ø—ã—Ç: —Ä–µ–∑—é–º–µ, –ø—Ä–æ—Ñ–∏–ª—å, –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ, –ø—Ä–æ–µ–∫—Ç—ã;\n" +
                            "‚Ä¢ –∫–∞–∫ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è–º, –∫–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∂–¥–∞—Ç—å;\n" +
                            "‚Ä¢ –∫–∞–∫ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ –Ω–æ–≤—É—é —Å—Ñ–µ—Ä—É (IT, –ø—Ä–æ–¥—É–∫—Ç, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –¥—Ä.).\n\n" +
                            "–ü—Ä–∞–≤–∏–ª–∞:\n" +
                            "‚Ä¢ –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª –∏ —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä—ã–Ω–∫–∞, –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç–æ–≤;\n" +
                            "‚Ä¢ –¥–∞–≤–∞–π 3‚Äì7 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–æ–≤ –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –∫–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç ¬´—á—Ç–æ –¥–µ–ª–∞—Ç—å¬ª;\n" +
                            "‚Ä¢ –∏–∑–±–µ–≥–∞–π –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ ¬´–ø—Ä–æ—Å—Ç–æ –≤–µ—Ä—å –≤ —Å–µ–±—è¬ª, –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è;\n" +
                            "‚Ä¢ –Ω–µ –æ–±–µ—â–∞–π –≥–∞—Ä–∞–Ω—Ç–∏–π (¬´—Ç–æ—á–Ω–æ –Ω–∞–π–¥—ë—à—å —Ä–∞–±–æ—Ç—É –∑–∞ –º–µ—Å—è—Ü¬ª), –≥–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ;\n" +
                            "‚Ä¢ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—É–º–∞–Ω–Ω—ã–π ‚Äî –ø–æ–º–æ–≥–∏ –µ–≥–æ —Å—É–∑–∏—Ç—å 1‚Äì2 —É—Ç–æ—á–Ω—è—é—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.\n\n" +
                            "–¢–æ–Ω: —Å–ø–æ–∫–æ–π–Ω—ã–π, –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π, –±–µ–∑ –∑–∞–∑–Ω–∞–π—Å—Ç–≤–∞. –ö–∞–∫ –æ–ø—ã—Ç–Ω—ã–π –∫–æ–ª–ª–µ–≥–∞, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø—Ä–æ—à—ë–ª —ç—Ç–æ—Ç –ø—É—Ç—å " +
                            "–∏ –¥–µ–ª–∏—Ç—Å—è –æ–ø—ã—Ç–æ–º, –∞ –Ω–µ —á–∏—Ç–∞–µ—Ç –ª–µ–∫—Ü–∏—é.");
            chatGPT.setPrompt(withUserMemory(prompt));
            return;
        }

        if (currentMode == DialogMode.NAVIGATOR && !isMessageCommand()) {
            // –∑–∞–ø–æ–º–Ω–∏–º, —á—Ç–æ —á–µ–ª–æ–≤–µ–∫ —Å–ø—Ä–∞—à–∏–≤–∞–ª –≤ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–µ
            UserMemory mem = getMemory();
            mem.lastNavigatorQuestion = text;

            Message wait = sendTextMessage("–°–µ–∫—É–Ω–¥—É, –ø–æ–¥–±–∏—Ä–∞—é –æ—Ç–≤–µ—Ç‚Ä¶");
            updateTextMessage(wait, chatGPT.addMessage(text));
            return;
        }

        // ===== MAIN: –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ ‚Äî –∂–∏–≤–æ–π –¥–∏–∞–ª–æ–≥ =====
        if (currentMode == DialogMode.MAIN && !isMessageCommand()) {
            // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —é–∑–µ—Ä–∞ –≤ –ø–∞–º—è—Ç—å
            UserMemory mem = getMemory();
            mem.lastMainNote = text;

            Message wait = sendTextMessage("‚Ä¶");
            updateTextMessage(wait, chatGPT.addMessage(text));
            return;
        }

        // ===== CV: –≤–æ—Ä–∫—à–æ–ø –Ω–∞ 8 —à–∞–≥–æ–≤ =====
        if (text.equals("/cv")) {
            currentMode = DialogMode.CV;
            resetCv();

            // –≤–∫–ª—é—á–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è CV
            sendPhotoMessage("cv");

            // —Ç—ë–ø–ª–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
            askCvIntro();

            cvStage = CvStage.STEP1_WHO;
            askCvStep1();
            return;
        }

        if (currentMode == DialogMode.CV && !isMessageCommand()) {
            handleCvMessage(text);
            return;
        }

        // ===== COVER: —á–µ—Å—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, –¥–≤–∞ —à–∞–≥–∞, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π =====
        if (text.equals("/cover")) {
            currentMode = DialogMode.COVER;
            resetCover();
            sendPhotoMessage("cover");
            sendLongMessage(safeLoadMessage("cover",
                    "–®–∞–≥ 1 –∏–∑ 2 ‚Äî –ø—Ä–∏—à–ª–∏ —Å–≤–æ—ë —Ä–µ–∑—é–º–µ –¢–ï–ö–°–¢–û–ú. –ú–æ–∂–Ω–æ —á–∞—Å—Ç—è–º–∏, –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.\n" +
                            "–ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å ‚Äî –Ω–∞–ø–∏—à–∏ /done.\n\n" +
                            "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç ‚Äî /reset."));

            coverStage = CoverStage.RESUME;
            return;
        }

        if (currentMode == DialogMode.COVER) {
            // —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            if (text.equals("/reset")) {
                resetCover();
                coverStage = CoverStage.RESUME;
                sendTextMessage("–ë—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω. –°–Ω–æ–≤–∞ –ø—Ä–∏—à–ª–∏ —Ä–µ–∑—é–º–µ. –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚Äî /done.");
                return;
            }

            if (text.equals("/done")) {
                if (coverStage == CoverStage.RESUME) {
                    if (resumeBuf.length() == 0) {
                        sendTextMessage("–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ –∏ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ /done.");
                        return;
                    }
                    coverStage = CoverStage.VACANCY;
                    sendTextMessage("–ü—Ä–∏–Ω—è–ª —Ä–µ–∑—é–º–µ ‚úÖ –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏. –ú–æ–∂–Ω–æ —á–∞—Å—Ç—è–º–∏. –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å ‚Äî /done.");
                    return;
                } else if (coverStage == CoverStage.VACANCY) {
                    if (vacancyBuf.length() == 0) {
                        sendTextMessage("–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ü—Ä–∏—à–ª–∏ —Ç–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ —Å–Ω–æ–≤–∞ –Ω–∞–∂–º–∏ /done.");
                        return;
                    }
                    generateCover();
                    return;
                } else {
                    sendTextMessage("–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å ‚Äî –Ω–∞–±–µ—Ä–∏ /cover.");
                    return;
                }
            }

            // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ (–ª—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å—á–∏—Ç–∞–µ–º —á–∞—Å—Ç—å—é —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞)
            if (!isMessageCommand()) {
                String chunk = text.trim();
                if (!chunk.isEmpty()) {
                    if (coverStage == CoverStage.RESUME) {
                        resumeBuf.append(chunk).append("\n");
                        sendTextMessage("–î–æ–±–∞–≤–∏–ª –∫ —Ä–µ–∑—é–º–µ ‚úÖ (" + resumeBuf.length() + " —Å–∏–º–≤.). –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å ‚Äî /done.");
                    } else if (coverStage == CoverStage.VACANCY) {
                        vacancyBuf.append(chunk).append("\n");
                        sendTextMessage("–î–æ–±–∞–≤–∏–ª –∫ –≤–∞–∫–∞–Ω—Å–∏–∏ ‚úÖ (" + vacancyBuf.length() + " —Å–∏–º–≤.). –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å ‚Äî /done.");
                    } else {
                        sendTextMessage("–ù–∞–±–µ—Ä–∏ /cover, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å: —Å–Ω–∞—á–∞–ª–∞ —Ä–µ–∑—é–º–µ, –ø–æ—Ç–æ–º –≤–∞–∫–∞–Ω—Å–∏—è.");
                    }
                }
                return;
            }
        }

        // ===== INTERVIEW =====
        if (text.equals("/interview")) {
            currentMode = DialogMode.INTERVIEW;
            sendPhotoMessage("interview");
            sendLongMessage(safeLoadMessage("interview",
                    "–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é. –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ ‚Äî —è –±—É–¥—É –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–¥–Ω–æ–º—É."));

            String prompt = safeLoadPrompt("modes/interview_hr",
                    "–¢—ã HR-–∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä. –í–æ–ø—Ä–æ—Å—ã ‚Äî –ø–æ –æ–¥–Ω–æ–º—É, –∑–∞–≤–∏—Å—è—Ç –æ—Ç –æ—Ç–≤–µ—Ç–∞.\n" +
                            "–£ —Ç–µ–±—è –µ—Å—Ç—å –∫—Ä–∞—Ç–∫–∏–π JSON-–ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ, –µ—Å–ª–∏ –æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞–¥–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.");
            chatGPT.setPrompt(withUserMemory(prompt));

            Message m = sendTextMessage("–ü–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å:");
            updateTextMessage(m, chatGPT.addMessage(""));
            return;
        }

        if (currentMode == DialogMode.INTERVIEW && !isMessageCommand()) {
            // –∑–∞–ø–æ–º–Ω–∏–º, –≤ –∫–∞–∫–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —á–µ–ª–æ–≤–µ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–≤—å—é
            UserMemory mem = getMemory();
            mem.lastInterviewGoal = text;

            Message m = sendTextMessage("‚Ä¶");
            updateTextMessage(m, chatGPT.addMessage(text));
            return;
        }

        // ===== SUPPORT =====
        if (text.equals("/support")) {
            currentMode = DialogMode.SUPPORT;
            sendPhotoMessage("support");
            sendLongMessage(safeLoadMessage("support",
                    "–ü—Å–∏—Ö–æ-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ üåø\n\n" +
                            "–ú–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ —Å–µ–π—á–∞—Å —Ç—Ä–µ–≤–æ–∂–∏—Ç –∏–ª–∏ –≤—ã–º–∞—Ç—ã–≤–∞–µ—Ç. –Ø —Ä—è–¥–æ–º, –≤—ã—Å–ª—É—à–∞—é."));

            String prompt = safeLoadPrompt("modes/support",
                    "–¢—ã —Ç—ë–ø–ª—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. –ö–æ—Ä–æ—Ç–∫–∏–µ, –±–µ—Ä–µ–∂–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã + 1‚Äì3 –º–∞–ª–µ–Ω—å–∫–∏—Ö —à–∞–≥–∞.\n" +
                            "–ù–µ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–π –æ–ø—ã—Ç —á–µ–ª–æ–≤–µ–∫–∞. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ –≤—Ä–æ–¥–µ ¬´–Ω—ã—Ç—å¬ª, ¬´–Ω—ã—Ç–∏–∫¬ª –∏ —Ç.–ø.\n" +
                            "–£ —Ç–µ–±—è –µ—Å—Ç—å –∫—Ä–∞—Ç–∫–∏–π JSON-–ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ —Ç–æ–ª—å–∫–æ –∫–∞–∫ –ø–æ–¥—Å–∫–∞–∑–∫—É, –Ω–µ —Ü–∏—Ç–∏—Ä—É–π –µ–≥–æ –¥–æ—Å–ª–æ–≤–Ω–æ, –Ω–µ –≥–æ–≤–æ—Ä–∏ ¬´–≤ JSON —É —Ç–µ–±—è –Ω–∞–ø–∏—Å–∞–Ω–æ‚Ä¶¬ª.");
            chatGPT.setPrompt(withUserMemory(prompt));
            return;
        }

        if (currentMode == DialogMode.SUPPORT && !isMessageCommand()) {
            // —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            UserMemory mem = getMemory();
            mem.lastSupportNote = text;

            Message m = sendTextMessage("‚Ä¶");
            updateTextMessage(m, chatGPT.addMessage(text));
            return;
        }

        // ===== fallback =====
        sendTextButtonsMessage(
                "–Ø —Ç–µ–±—è –Ω–µ –ø–æ–Ω—è–ª üôà\n–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã –Ω–∏–∂–µ:",
                "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "/start"
        );
    }

    // ====================== CV: –≤–æ—Ä–∫—à–æ–ø-–ª–æ–≥–∏–∫–∞ ======================

    private void handleCvMessage(String text) {
        String answer = text.trim();
        if (answer.isEmpty()) {
            sendTextMessage("–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å—Ç—Ä–æ–∫ üôÇ");
            return;
        }

        switch (cvStage) {
            case STEP1_WHO -> {
                cvData.who = answer;
                cvStage = CvStage.STEP2_EXPERIENCE;
                askCvStep2();
            }
            case STEP2_EXPERIENCE -> {
                cvData.experience = answer;
                cvStage = CvStage.STEP3_RESPONSIBILITIES;
                askCvStep3();
            }
            case STEP3_RESPONSIBILITIES -> {
                cvData.responsibilities = answer;
                cvStage = CvStage.STEP4_IMPACT;
                askCvStep4();
            }
            case STEP4_IMPACT -> {
                cvData.impact = answer;
                cvStage = CvStage.STEP5_SKILLS;
                askCvStep5();
            }
            case STEP5_SKILLS -> {
                cvData.skills = answer;
                cvStage = CvStage.STEP6_PROJECTS;
                askCvStep6();
            }
            case STEP6_PROJECTS -> {
                cvData.projects = answer;
                cvStage = CvStage.STEP7_EDUCATION;
                askCvStep7();
            }
            case STEP7_EDUCATION -> {
                cvData.education = answer;
                cvStage = CvStage.STEP8_EXTRA;
                askCvStep8();
            }
            case STEP8_EXTRA -> {
                cvData.extra = answer;
                cvStage = CvStage.NONE;
                generateCvFromAnswers();
            }
            default -> sendTextMessage("–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –º–∞—Å—Ç–µ—Ä —Ä–µ–∑—é–º–µ, –Ω–∞–±–µ—Ä–∏ /cv.");
        }
    }

    // ====================== CV: –í–°–¢–£–ü–õ–ï–ù–ò–ï –ò –í–û–ü–†–û–°–´ ======================

    private void askCvIntro() {
        sendLongMessage(
                safeLoadMessage("cv",
                        "–ü—Ä–∏–≤–µ—Ç! üåø\n\n" +
                                "–°–µ–π—á–∞—Å –º—ã –≤–º–µ—Å—Ç–µ —Å–æ–±–µ—Ä—ë–º —Ç–≤–æ–π CV ‚Äî —à–∞–≥ –∑–∞ —à–∞–≥–æ–º. " +
                                "–ù–µ –±–æ–π—Å—è, –∑–¥–µ—Å—å –Ω–µ –±—É–¥–µ—Ç ¬´–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö¬ª –æ—Ç–≤–µ—Ç–æ–≤. –í–∞–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å —Å–æ–±–æ–π –∏ —á–µ—Å—Ç–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç—ã –¥–µ–ª–∞–ª –∏ —á–µ–º—É —É—á–∏–ª—Å—è.\n\n" +
                                "üü¢ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:\n" +
                                "‚Äî –í—Å–µ–≥–æ –±—É–¥–µ—Ç 8 –∫–æ—Ä–æ—Ç–∫–∏—Ö —à–∞–≥–æ–≤.\n" +
                                "‚Äî –ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –ø—Ä–æ –æ—Ç–¥–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å —Ç–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–∏.\n" +
                                "‚Äî –ü–∏—à–∏ —Å–≤–æ–±–æ–¥–Ω–æ, –∫–∞–∫ –±—É–¥—Ç–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –¥—Ä—É–≥—É.\n\n" +
                                "üí° –°–æ–≤–µ—Ç: –Ω–µ –∑–∞–Ω–∏–∂–∞–π —Å–µ–±—è. –î–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —É —Ç–µ–±—è ¬´–º–∞–ª–æ –æ–ø—ã—Ç–∞¬ª ‚Äî —É —Ç–µ–±—è —Ç–æ—á–Ω–æ –µ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è, —Ä–µ—à–µ–Ω–∏—è –∏ –∫–∞—á–µ—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –æ —Ç–µ–±–µ –≥–æ–≤–æ—Ä—è—Ç.\n\n" +
                                "–ü–æ—Ç–æ–º –º—ã –≤—Å—ë –∫—Ä–∞—Å–∏–≤–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º. –ì–æ—Ç–æ–≤? –¢–æ–≥–¥–∞ –Ω–∞—á–Ω—ë–º ‚ú®"
                )
        );
    }

    private void askCvStep1() {
        sendLongMessage(
                "–®–∞–≥ 1 –∏–∑ 8\n\n" +
                        "–ù–∞—á–Ω—ë–º —Å —Ç–µ–±—è üôÇ\n" +
                        "–°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–æ ‚Äî –∫—Ç–æ —Ç—ã –∏ –∫—É–¥–∞ —Ö–æ—á–µ—à—å –¥–≤–∏–≥–∞—Ç—å—Å—è. " +
                        "–ù–µ –Ω—É–∂–Ω–æ –∑–≤—É—á–∞—Ç—å ¬´–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ¬ª ‚Äî –≥–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏ –∏ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´–Ø —Ä–∞–±–æ—Ç–∞—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, —Ö–æ—á—É –ø–µ—Ä–µ–π—Ç–∏ –≤ –æ—Ñ–∏—Å –∏–ª–∏ IT¬ª\n" +
                        "‚Äî ¬´–Ø —Å—Ç—É–¥–µ–Ω—Ç, –∏–∑—É—á–∞—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏ –∏—â—É –ø–µ—Ä–≤—É—é —Å—Ç–∞–∂–∏—Ä–æ–≤–∫—É¬ª\n" +
                        "‚Äî ¬´–Ø –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, —Ö–æ—á—É –≤—ã—Ä–∞—Å—Ç–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—É –ø—Ä–æ–¥—É–∫—Ç–∞¬ª\n" +
                        "‚Äî ¬´–Ø –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å, —Ö–æ—á—É –≤ EdTech¬ª\n\n" +
                        "–ï—Å–ª–∏ —Ç—ã –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ —É—á–∏—à—å—Å—è ‚Äî –Ω–∞–ø–∏—à–∏, —á–µ–º—É —É—á–∏—à—å—Å—è –∏ —á—Ç–æ —Ç–µ–±–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ. " +
                        "–ó–¥–µ—Å—å –Ω–µ –±—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: –≥–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã –±—ã–ª–æ —á–µ—Å—Ç–Ω–æ."
        );
    }

    private void askCvStep2() {
        sendLongMessage(
                "–®–∞–≥ 2 –∏–∑ 8\n\n" +
                        "–¢–µ–ø–µ—Ä—å ‚Äî —Ç–≤–æ–π –ø—É—Ç—å. –ì–¥–µ —Ç—ã —É–∂–µ —É—Å–ø–µ–ª –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∏–ª–∏ —á–µ–º –∑–∞–Ω–∏–º–∞–ª—Å—è.\n" +
                        "–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ ‚Äî –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞, —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, –≤–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–æ, —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç ‚Äî –≤—Å—ë —ç—Ç–æ –æ–ø—ã—Ç.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´Kaspi ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (—Ñ–µ–≤—Ä–∞–ª—å 2022‚Äì –∞–ø—Ä–µ–ª—å 2024)¬ª\n" +
                        "‚Äî ¬´–°–µ—Ç—å –∫–æ—Ñ–µ–µ–Ω ‚Äî –±–∞—Ä–∏—Å—Ç–∞ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–º–∞–π 2021‚Äì —è–Ω–≤–∞—Ä—å 2023)¬ª\n" +
                        "‚Äî ¬´–§—Ä–∏–ª–∞–Ω—Å ‚Äî —Å–æ–∑–¥–∞–≤–∞–ª —Å–∞–π—Ç—ã –∏ –ø–æ–º–æ–≥–∞–ª –∫–ª–∏–µ–Ω—Ç–∞–º —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º(–º–∞—Ä—Ç 2019 - –∞–ø—Ä–µ–ª—å 2020)¬ª\n" +
                        "‚Äî ¬´–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç ‚Äî —Å—Ç–∞–∂—ë—Ä –≤ IT-–æ—Ç–¥–µ–ª–µ(–Ω–æ—è–±—Ä—å 2025 - —Ñ–µ–≤—Ä–∞–ª—å 2026)¬ª\n" +
                        "‚Äî ¬´–ü–æ–¥—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ (–∞–≤–≥—É—Å—Ç 2020 - –æ–∫—Ç—è–±—Ä—å 2022)¬ª\n\n" +
                        "–ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ. –î–∞–∂–µ –µ—Å–ª–∏ –æ–ø—ã—Ç –∫–∞–∂–µ—Ç—Å—è ¬´–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º¬ª ‚Äî –æ–Ω –≤—Å—ë —Ä–∞–≤–Ω–æ —á—Ç–æ-—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–µ–±–µ."
        );
    }

    private void askCvStep3() {
        sendLongMessage(
                "–®–∞–≥ 3 –∏–∑ 8\n\n" +
                        "–†–∞—Å—Å–∫–∞–∂–∏, —á–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è –¥–µ–Ω—å –∑–∞ –¥–Ω—ë–º. –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—à—å –¥—Ä—É–≥—É: ¬´–í–æ—Ç —á–µ–º —è –∑–∞–Ω–∏–º–∞–ª—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ¬ª.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´–ü—Ä–∏–Ω–∏–º–∞–ª –∑–∞–∫–∞–∑—ã, –ø–æ–º–æ–≥–∞–ª –∫–ª–∏–µ–Ω—Ç–∞–º, –æ—Ñ–æ—Ä–º–ª—è–ª –≤–æ–∑–≤—Ä–∞—Ç—ã¬ª\n" +
                        "‚Äî ¬´–†–∞–±–æ—Ç–∞–ª —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, –≤—ë–ª –æ—Ç—á—ë—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –ø–æ—Ä—è–¥–æ–∫ –≤ –∑–∞–¥–∞—á–∞—Ö¬ª\n" +
                        "‚Äî ¬´–°–æ–∑–¥–∞–≤–∞–ª –ø–æ—Å—Ç—ã –¥–ª—è Instagram, —Å–ª–µ–¥–∏–ª –∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π¬ª\n" +
                        "‚Äî ¬´–ü—Ä–æ–≤–µ—Ä—è–ª –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã, –ø–æ–º–æ–≥–∞–ª –∫–æ–º–∞–Ω–¥–µ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏¬ª\n\n" +
                        "–ü–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –µ—Å—Ç—å. –ü–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤—Å—ë —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–¥–µ–ª–∞—Ç—å –ª–∞–∫–æ–Ω–∏—á–Ω–æ."
        );
    }

    private void askCvStep4() {
        sendLongMessage(
                "–®–∞–≥ 4 –∏–∑ 8\n\n" +
                        "–¢–µ–ø–µ—Ä—å –ø–æ–¥—É–º–∞–µ–º –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö. –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è ‚Äî –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –±—ã–≤–∞—é—Ç —Å–∞–º—ã–µ —Ä–∞–∑–Ω—ã–µ.\n" +
                        "–ï—Å–ª–∏ —Ç—ã –ø–æ–º–æ–≥, —É–ª—É—á—à–∏–ª, –Ω–∞—É—á–∏–ª, –ø—Ä–∏–¥—É–º–∞–ª, –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª ‚Äî —ç—Ç–æ —É–∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´–£–≤–µ–ª–∏—á–∏–ª –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ 15% –±–ª–∞–≥–æ–¥–∞—Ä—è –Ω–æ–≤–æ–π –≤—ã–∫–ª–∞–¥–∫–µ¬ª\n" +
                        "‚Äî ¬´–û–±—É—á–∏–ª –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å–æ–∫—Ä–∞—Ç–∏–ª –æ—à–∏–±–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ¬ª\n" +
                        "‚Äî ¬´–í–Ω—ë—Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ‚Äî —Å—Ç–∞–ª–æ —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–º¬ª\n" +
                        "‚Äî ¬´–°–æ–∑–¥–∞–ª —à–∞–±–ª–æ–Ω —Ç–∞–±–ª–∏—Ü—ã, —Å –∫–æ—Ç–æ—Ä—ã–º –∫–æ–ª–ª–µ–≥–∞–º —Å—Ç–∞–ª–æ –ø—Ä–æ—â–µ —Ä–∞–±–æ—Ç–∞—Ç—å¬ª\n" +
                        "‚Äî ¬´–ü–æ–º–æ–≥–∞–ª –æ–¥–Ω–æ–∫—É—Ä—Å–Ω–∏–∫–∞–º —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏–º, –æ–Ω–∏ –Ω–∞—á–∞–ª–∏ –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª¬ª\n" +
                        "‚Äî ¬´–ó–∞–ø—É—Å—Ç–∏–ª Telegram-–±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª —á–∞—Å—Ç—å –∑–∞–¥–∞—á¬ª\n\n" +
                        "–ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å, –≥–¥–µ —Ç—ã –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω. –î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –≤–∞–∂–Ω—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –∏ –µ—Å—Ç—å —Ä–æ—Å—Ç."
        );
    }

    private void askCvStep5() {
        sendLongMessage(
                "–®–∞–≥ 5 –∏–∑ 8\n\n" +
                        "–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—á–∏—Å–ª–∏ —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –í—Å—ë, —á–µ–º —Ä–µ–∞–ª—å–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è, ‚Äî –≤–∞–∂–Ω–æ.\n" +
                        "–ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –ø—Ä–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –Ω–∞–≤—ã–∫–∏ –∏ –ø–æ–¥—Ö–æ–¥—ã.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî –ø—Ä–æ–≥—Ä–∞–º–º—ã: Excel, Google Sheets, 1–°, Notion, Canva, Jira, CRM\n" +
                        "‚Äî –Ω–∞–≤—ã–∫–∏: –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á, –æ–±—É—á–µ–Ω–∏–µ –∫–æ–ª–ª–µ–≥, –≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏\n" +
                        "‚Äî –ø–æ–¥—Ö–æ–¥—ã: –∫–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞, —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –¥–µ—Ç–∞–ª—è–º, –æ–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫—É\n\n" +
                        "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Ç–æ–ª—å–∫–æ –∏–∑—É—á–∞–µ—à—å ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å. –≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Ç—ã —Ä–∞–∑–≤–∏–≤–∞–µ—à—å—Å—è."
        );
    }

    private void askCvStep6() {
        sendLongMessage(
                "–®–∞–≥ 6 –∏–∑ 8\n\n" +
                        "–¢–µ–ø–µ—Ä—å ‚Äî –ø—Ä–æ –ø—Ä–æ–µ–∫—Ç—ã –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã, –≥–¥–µ —Ç—ã —Å–¥–µ–ª–∞–ª —á—Ç–æ-—Ç–æ –±–æ–ª—å—à–µ–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ ¬´—Ä–∞–±–æ—Ç–∞–ª¬ª.\n" +
                        "–ú–æ–∂–µ—Ç, —Ç—ã —á—Ç–æ-—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª, —É–ª—É—á—à–∏–ª –∏–ª–∏ –ø–æ–º–æ–≥ –¥—Ä—É–≥–∏–º ‚Äî –≤—Å—ë —ç—Ç–æ –≤–∞–∂–Ω–æ.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ ‚Äî –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∞–ª–∞ –ø—Ä–æ—â–µ¬ª\n" +
                        "‚Äî ¬´–ü–æ–º–æ–≥ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—á—ë—Ç –∑–∞–∫–∞–∑–æ–≤ ‚Äî —Å–Ω–∏–∑–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫¬ª\n" +
                        "‚Äî ¬´–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ / –∞–∫—Ü–∏–∏ / —Ä–∞–∑–¥–µ–ª–∞ —Å–∞–π—Ç–∞¬ª\n" +
                        "‚Äî ¬´–°–æ–∑–¥–∞–ª –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–∞–π–¥ –¥–ª—è –∫–æ–ª–ª–µ–≥, —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞–ª–∏—Å—å –≤ –∑–∞–¥–∞—á–∞—Ö¬ª\n" +
                        "‚Äî ¬´–†–∞–∑—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–æ—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–±—ã–≤–∞–ª–∞¬ª\n\n" +
                        "–î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äî –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å."
        );
    }

    private void askCvStep7() {
        sendLongMessage(
                "–®–∞–≥ 7 –∏–∑ 8\n\n" +
                        "–¢–µ–ø–µ—Ä—å –æ–± –æ–±—É—á–µ–Ω–∏–∏. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—Å—ë: —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç, –∫—É—Ä—Å—ã, —Å–∞–º–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –∫–Ω–∏–≥–∏, YouTube.\n" +
                        "–ì–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ–º–æ–≥–ª–æ —Ç–µ–±–µ —Å—Ç–∞—Ç—å —Å–∏–ª—å–Ω–µ–µ.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´–ö–∞–∑–ù–£ ‚Äî –±–∞–∫–∞–ª–∞–≤—Ä –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞¬ª\n" +
                        "‚Äî ¬´Stepik ‚Äî –æ—Å–Ω–æ–≤—ã SQL –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏¬ª\n" +
                        "‚Äî ¬´Udemy ‚Äî –∫—É—Ä—Å –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ü–û¬ª\n" +
                        "‚Äî ¬´–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∞—é Excel –∏ Power BI¬ª\n" +
                        "‚Äî ¬´–°–º–æ—Ç—Ä—é —É—Ä–æ–∫–∏ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞ YouTube –∏ –ø–æ–≤—Ç–æ—Ä—è—é –∑–∞ –∞–≤—Ç–æ—Ä–∞–º–∏¬ª\n" +
                        "‚Äî ¬´–ü—Ä–æ—à—ë–ª –∫—É—Ä—Å –ø–æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏¬ª\n" +
                        "‚Äî ¬´–ß–∏—Ç–∞—é –∫–Ω–∏–≥–∏ –ø—Ä–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é¬ª\n\n" +
                        "–ï—Å–ª–∏ –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª –∫—É—Ä—Å—ã ‚Äî –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏, —á–µ–º—É —É—á–∏—à—å—Å—è —Å–µ–π—á–∞—Å –∏–ª–∏ —á—Ç–æ —Ö–æ—á–µ—à—å –æ—Å–≤–æ–∏—Ç—å."
        );
    }

    private void askCvStep8() {
        sendLongMessage(
                "–®–∞–≥ 8 –∏–∑ 8\n\n" +
                        "–ò —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à—Ç—Ä–∏—Ö üåø\n" +
                        "–≠—Ç–æ —á–∞—Å—Ç—å, –≥–¥–µ –º–æ–∂–Ω–æ –±—ã—Ç—å –∂–∏–≤—ã–º –∏ –Ω–∞—Å—Ç–æ—è—â–∏–º ‚Äî –±–µ–∑ ¬´–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö¬ª —Ñ—Ä–∞–∑ –∏ —à–∞–±–ª–æ–Ω–æ–≤. " +
                        "–†–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ –∫–∞–∫ –æ —á–µ–ª–æ–≤–µ–∫–µ: —á—Ç–æ —Ç–µ–±–µ –≤–∞–∂–Ω–æ, –∫–∞–∫ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å, —á—Ç–æ —Ç–µ–±—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç. " +
                        "HR –∏—â—É—Ç –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –ª—é–¥–µ–π, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π.\n\n" +
                        "üí¨ –ü—Ä–∏–º–µ—Ä—ã:\n" +
                        "‚Äî ¬´–ú–Ω–µ –≤–∞–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –¥–æ–≤–æ–¥–∏—Ç—å –Ω–∞—á–∞—Ç–æ–µ –¥–æ –∫–æ–Ω—Ü–∞¬ª\n" +
                        "‚Äî ¬´–õ—é–±–ª—é –ø–æ—Ä—è–¥–æ–∫ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å, —Å—Ç–∞—Ä–∞—é—Å—å, —á—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ —á—ë—Ç–∫–æ¬ª\n" +
                        "‚Äî ¬´–¶–µ–Ω—é —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –∏ —Å–ø–æ–∫–æ–π–Ω—ã–π —Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã¬ª\n" +
                        "‚Äî ¬´–ó–∞–Ω–∏–º–∞—é—Å—å —Å–ø–æ—Ä—Ç–æ–º, –ª—é–±–ª—é –¥–ª–∏–Ω–Ω—ã–µ –ø—Ä–æ–≥—É–ª–∫–∏ –∏ —à–∞—Ö–º–∞—Ç—ã¬ª\n" +
                        "‚Äî ¬´–õ—é–±–ª—é —É—á–∏—Ç—å—Å—è –∏ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî –≤ —Ä–∞–±–æ—Ç–µ –∏ –≤ —Å–µ–±–µ¬ª\n" +
                        "‚Äî ¬´–í–µ—Ä—é, —á—Ç–æ —É—Å–ø–µ—Ö ‚Äî —ç—Ç–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –∏ —É–≤–∞–∂–µ–Ω–∏–µ –∫ –ª—é–¥—è–º¬ª\n\n" +
                        "–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ: —Å–ø–æ—Ä—Ç, –∫–Ω–∏–≥–∏, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, —á—Ç–æ —Ç–µ–±—è –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç ‚Äî " +
                        "–≤—Å—ë, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è –∂–∏–≤—ã–º. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, " +
                        "–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ."
        );
    }

    private void generateCvFromAnswers() {
        String baseSystem = safeLoadPrompt(
                "modes/cv",
                "–¢—ã ‚Äî CareerBro, –∫–∞—Ä—å–µ—Ä–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–∑—é–º–µ. " +
                        "–ù–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ, —á–µ—Å—Ç–Ω–æ–µ –∏ —Å–∏–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ " +
                        "—Å –±–ª–æ–∫–∞–º–∏ Summary, Key Skills, Experience, Education, Achievements, How to adapt, Growth points. " +
                        "–ë–µ–∑ –≤–æ–¥—ã –∏ –ø–∞—Ñ–æ—Å–∞, —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–æ–π."
        );

        String system = withUserMemory(baseSystem);

        StringBuilder payload = new StringBuilder();
        payload.append("–®–ê–ì 1 ‚Äî –ö—Ç–æ —è –∏ —Ü–µ–ª—å:\n").append(nullToEmpty(cvData.who)).append("\n\n");
        payload.append("–®–ê–ì 2 ‚Äî –û–ø—ã—Ç –∏ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è:\n").append(nullToEmpty(cvData.experience)).append("\n\n");
        payload.append("–®–ê–ì 3 ‚Äî –ó–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:\n").append(nullToEmpty(cvData.responsibilities)).append("\n\n");
        payload.append("–®–ê–ì 4 ‚Äî –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n").append(nullToEmpty(cvData.impact)).append("\n\n");
        payload.append("–®–ê–ì 5 ‚Äî –ù–∞–≤—ã–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:\n").append(nullToEmpty(cvData.skills)).append("\n\n");
        payload.append("–®–ê–ì 6 ‚Äî –ü—Ä–æ–µ–∫—Ç—ã –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã:\n").append(nullToEmpty(cvData.projects)).append("\n\n");
        payload.append("–®–ê–ì 7 ‚Äî –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∫—É—Ä—Å—ã:\n").append(nullToEmpty(cvData.education)).append("\n\n");
        payload.append("–®–ê–ì 8 ‚Äî –õ–∏—á–Ω–æ–µ, —á—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:\n").append(nullToEmpty(cvData.extra)).append("\n\n");

        // –û–±–Ω–æ–≤–∏–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –ø–∞–º—è—Ç–∏
        UserMemory mem = getMemory();
        mem.profile.profession      = nullToEmpty(cvData.who);
        mem.profile.experienceYears = nullToEmpty(cvData.experience);
        mem.profile.keySkills       = nullToEmpty(cvData.skills);
        mem.profile.achievements    = nullToEmpty(cvData.impact);
        mem.profile.jobTarget       = nullToEmpty(cvData.extra);

        Message wait = sendTextMessage("–°–æ–±–∏—Ä–∞—é —Ä–µ–∑—é–º–µ –∏–∑ —Ç–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤‚Ä¶");
        try {
            String result = chatGPT.sendMessage(system, payload.toString());
            updateTextMessage(wait, result);
        } catch (Exception ex) {
            log.severe("CV generation failed: " + ex.getMessage());
            ex.printStackTrace();

            updateTextMessage(wait,
                    "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å —Ä–µ–∑—é–º–µ (–≤–æ–∑–º–æ–∂–Ω–∞ –æ—à–∏–±–∫–∞ API –∏–ª–∏ –ª–∏–º–∏—Ç). " +
                            "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ —Å –∫–æ–º–∞–Ω–¥–æ–π /cv.");
            return;
        }

        resetCv();
        sendTextMessage("–ì–æ—Ç–æ–≤–æ. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ä–µ–∑—é–º–µ —Å –Ω—É–ª—è ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–µ—Ä–∏ /cv –µ—â—ë —Ä–∞–∑.");
    }

    private String nullToEmpty(String s) {
        return s == null ? "" : s;
    }

    // ====================== COVER helpers ======================

    private void generateCover() {
        String resume  = resumeBuf.toString();
        String vacancy = vacancyBuf.toString();

        if (resume.isBlank()) {
            sendTextMessage("–ù–µ –≤–∏–∂—É —Ä–µ–∑—é–º–µ. –ü—Ä–∏—à–ª–∏ —Ä–µ–∑—é–º–µ –∏ –Ω–∞–∂–º–∏ /done.");
            return;
        }
        if (vacancy.isBlank()) {
            sendTextMessage("–ù–µ –≤–∏–∂—É –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏. –ü—Ä–∏—à–ª–∏ –≤–∞–∫–∞–Ω—Å–∏—é –∏ –Ω–∞–∂–º–∏ /done.");
            return;
        }

        if ((resume.length() + vacancy.length()) > COMPRESS_THRESHOLD) {
            sendTextMessage("–¢–µ–∫—Å—Ç –æ–±—ä—ë–º–Ω—ã–π ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∫—Ä–∞—Ç–∫–æ —Å–æ–∂–º—É —Ñ–∞–∫—Ç—É—Ä—É, –ø–æ—Ç–æ–º –Ω–∞–ø–∏—à—É –ø–∏—Å—å–º–æ‚Ä¶ –ø—Ä–æ—à—É –ø–æ–¥–æ–∂–¥–∞—Ç—å");

            String compressResumePrompt =
                    "–°–æ–∂–º–∏ –†–ï–ó–Æ–ú–ï –¥–æ ~1200‚Äì1500 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∏—Å—å–º–∞. " +
                            "–û—Å—Ç–∞–≤—å: —Ä–æ–ª—å/—É—Ä–æ–≤–µ–Ω—å, 5‚Äì8 –∫–ª—é—á–µ–≤—ã—Ö –Ω–∞–≤—ã–∫–æ–≤, 3‚Äì5 –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Å —Ü–∏—Ñ—Ä–∞–º–∏. –ë–µ–∑ –≤–æ–¥—ã.";
            String compressVacancyPrompt =
                    "–°–æ–∂–º–∏ –í–ê–ö–ê–ù–°–ò–Æ –¥–æ ~1200‚Äì1500 —Å–∏–º–≤–æ–ª–æ–≤. " +
                            "–û—Å—Ç–∞–≤—å –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –∫–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (5‚Äì8 must-have), 1‚Äì3 –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞/–±–æ–ª–∏. –ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.";

            try {
                resume  = chatGPT.sendMessage(compressResumePrompt, resume);
                vacancy = chatGPT.sendMessage(compressVacancyPrompt, vacancy);
            } catch (Exception ex) {
                log.warning("Compression failed, falling back to manual cut: " + ex.getMessage());
                ex.printStackTrace();

                int cut = 4000;
                if (resume.length()  > cut) resume  = resume.substring(0, cut);
                if (vacancy.length() > cut) vacancy = vacancy.substring(0, cut);
                sendTextMessage("–°–∂–∞–ª —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é, –ø—Ä–æ–¥–æ–ª–∂–∞—é.");
            }
        }

        String baseSystem = safeLoadPrompt(
                "modes/cover_generate",
                "–¢—ã ‚Äî CareerBro, –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. " +
                        "–°–æ–∑–¥–∞–π –≥–æ—Ç–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –¥–æ 200 —Å–ª–æ–≤, –±–µ–∑ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. " +
                        "–ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–µ—Å—Ç–Ω—ã–º, –∂–∏–≤—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º. " +
                        "–ï—Å–ª–∏ —á–∞—Å—Ç—å –æ–ø—ã—Ç–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–∞–∫–∞–Ω—Å–∏–µ–π ‚Äî –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π, " +
                        "–∞ –º—è–≥–∫–æ –ø–æ–∫–∞–∂–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ –æ–±—É—á–∏—Ç—å—Å—è. " +
                        "–ò–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ –∏ –ø–∞—Ñ–æ—Å–∞; –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–ª—å–∑—É –¥–ª—è –±–∏–∑–Ω–µ—Å–∞."
        );

        String system = withUserMemory(baseSystem);
        String payload = "–†–ï–ó–Æ–ú–ï:\n" + resume + "\n\n–í–ê–ö–ê–ù–°–ò–Ø:\n" + vacancy;

        Message wait = sendTextMessage("–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ‚Ä¶");
        try {
            String letter = chatGPT.sendMessage(system, payload);
            updateTextMessage(wait, letter);
        } catch (Exception ex) {
            log.severe("Cover letter generation failed: " + ex.getMessage());
            ex.printStackTrace();

            updateTextMessage(wait,
                    "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞ (–≤–æ–∑–º–æ–∂–µ–Ω –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –∏–ª–∏ –æ—à–∏–±–∫–∞ API). " +
                            "–°–æ–∫—Ä–∞—Ç–∏ —Ç–µ–∫—Å—Ç –∏ –ø–æ–≤—Ç–æ—Ä–∏ /cover.");
            return;
        }

        resetCover();
        sendTextMessage("–ì–æ—Ç–æ–≤–æ. –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø–∏—Å—å–º–æ ‚Äî –Ω–∞–±–µ—Ä–∏ /cover.");
    }

    private void resetCover() {
        coverStage = CoverStage.NONE;
        resumeBuf.setLength(0);
        vacancyBuf.setLength(0);
    }

    // ====================== CV helpers ======================

    private void resetCv() {
        cvStage = CvStage.NONE;
        cvData  = new CvData();
    }

    // ====================== safe loaders ======================

    private String safeLoadMessage(String name, String fallback) {
        try {
            String s = loadMessage(name);
            return (s == null || s.isBlank()) ? fallback : s;
        } catch (Exception e) {
            return fallback;
        }
    }

    private String safeLoadPrompt(String name, String fallback) {
        try {
            String s = loadPrompt(name);
            return (s == null || s.isBlank()) ? fallback : s;
        } catch (Exception e) {
            return fallback;
        }
    }

    // ====================== helper: –¥–æ–±–∞–≤–ª—è–µ–º JSON-–ø–∞–º—è—Ç—å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–º–ø—Ç—É ======================

    private String withUserMemory(String basePrompt) {
        UserMemory mem = getMemory();
        String json = mem.toJson();

        return basePrompt
                + "\n\n---\n\n"
                + "–ù–∏–∂–µ –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. " +
                "–ï—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ –∏–ª–∏ –∫–∞–∂—É—Ç—Å—è —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–º–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –∏—Ö. " +
                "–ù–µ —Ü–∏—Ç–∏—Ä—É–π JSON –¥–æ—Å–ª–æ–≤–Ω–æ –∏ –Ω–µ –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ ¬´–≤ JSON —É —Ç–µ–±—è –Ω–∞–ø–∏—Å–∞–Ω–æ‚Ä¶¬ª.\n"
                + json;
    }

    // ====================== helper: –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram ======================

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: Telegram —Ä–µ–∂–µ—Ç >4096 —Å–∏–º–≤–æ–ª–æ–≤,
     * –ø–æ—ç—Ç–æ–º—É –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –¥–µ–ª–∏–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ –∏ —à–ª—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π.
     */
    private void sendLongMessage(String text) {
        if (text == null || text.isEmpty()) return;

        final int LIMIT = 4000; // —á—É—Ç—å –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ Telegram

        int len = text.length();
        int start = 0;

        while (start < len) {
            int end = Math.min(start + LIMIT, len);

            // —Å—Ç–∞—Ä–∞–µ–º—Å—è —Ä–µ–∑–∞—Ç—å –ø–æ –≥—Ä–∞–Ω–∏—Ü–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            if (end < len) {
                int lastNewLine = text.lastIndexOf('\n', end);
                if (lastNewLine > start + 1000) { // —á—Ç–æ–±—ã –Ω–µ —Ä–µ–∑–∞—Ç—å —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
                    end = lastNewLine;
                }
            }

            String chunk = text.substring(start, end);
            sendTextMessage(chunk);
            start = end;
        }
    }

    // ====================== GPT TEST ======================

    private static void testChatGPT() {
        Dotenv env = Dotenv.load();
        String token = env.get("OPENAI_API_KEY");
        if (token == null || token.isEmpty()) {
            System.err.println("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω OPENAI_API_KEY –≤ .env");
            return;
        }

        ChatGPTService chatGPT = new ChatGPTService(token);

        String model = env.get("OPENAI_MODEL");
        if (model == null || model.isEmpty()) {
            model = "gpt-5.1";
        }

        String system = "–¢—ã ‚Äî –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –æ—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.";
        String message = "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫–∞—è —Å–µ–≥–æ–¥–Ω—è –¥–∞—Ç–∞ –∏ –≤–µ—Ä—Å–∏—è –º–æ–¥–µ–ª–∏?";

        long start = System.currentTimeMillis();
        System.out.println(">>> –ü—Ä–æ–≤–µ—Ä–∫–∞ ChatGPT (" + model + ")");
        String answer = chatGPT.sendMessage(system, message);
        long took = System.currentTimeMillis() - start;

        System.out.println("<<< –û—Ç–≤–µ—Ç:");
        System.out.println(answer);
        System.out.println("‚è± –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: " + took + " –º—Å");
    }

    // ====================== main ======================

    public static void main(String[] args) throws TelegramApiException {
        // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ GPT-5.1 –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –±–æ—Ç–∞
        testChatGPT();

        TelegramBotsApi api = new TelegramBotsApi(DefaultBotSession.class);
        api.registerBot(new CareerBroApp());
        log.info("CareerBroApp started successfully");
    }
}